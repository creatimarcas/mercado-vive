<style>
  form#productForm {
    max-width: 500px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 12px;
    background: #f9f9f9;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }
  form#productForm label {
    font-weight: bold;
    margin-top: 10px;
  }
  form#productForm input,
  form#productForm select,
  form#productForm button {
    padding: 8px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  form#productForm button {
    background-color: #2E8B57;
    color: white;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  form#productForm button:hover {
    background-color: #256f48;
  }
  #imgPreview {
    max-width: 100%;
    height: auto;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 5px;
  }
</style>

<!-- Formulario completo para crear/editar productos con subida de imagen -->

<form id="productForm">
  <h2 id="formTitle">Añadir Nuevo Producto</h2>

  <label for="nombre">Nombre:</label>
  <input type="text" id="nombre" name="nombre" required>

  <label for="categoria">Categoría:</label>
  <select id="categoria" name="categoria" required>
    <option value="">Seleccione una categoría</option>
    <option value="Frutas">Frutas</option>
    <option value="Verduras">Verduras</option>
    <option value="Lácteos">Lácteos</option>
    <option value="Huevos">Huevos</option>
    <option value="Abarrotes">Abarrotes</option>
    <option value="Carnes">Carnes</option>
    <option value="Panadería">Panadería</option>
    <option value="Bolsas">Bolsas</option>
    <option value="Desechables">Desechables</option>
  </select>

  <label for="precio">Precio:</label>
  <input type="number" id="precio" name="precio" step="0.01" required>

  <label for="precio_anterior">Precio Anterior:</label>
  <input type="number" id="precio_anterior" name="precio_anterior" step="0.01">

  <label for="etiqueta">Etiqueta:</label>
  <input type="text" id="etiqueta" name="etiqueta">

  <label for="valoracion">Valoración:</label>
  <input type="number" id="valoracion" name="valoracion" step="0.1" min="0" max="5">

  <label for="reseñas">Reseñas:</label>
  <input type="number" id="reseñas" name="reseñas">

  <label for="unidad">Unidad:</label>
  <input type="text" id="unidad" name="unidad">

  <!-- Campo de carga de imagen -->
  <label for="fileInput">Seleccionar imagen:</label>
  <input type="file" id="fileInput" accept="image/*">
  <input type="hidden" id="imagen" name="imagen">
  <img id="imgPreview" src="" alt="Vista previa" style="display: none; max-width: 200px; margin-top: 10px;">

  <input type="hidden" id="productId" name="id">

  <button id="submitBtn" type="submit">Guardar</button>
  <button id="cancelEditBtn" type="button" style="display: none;">Cancelar</button>
</form>

<script>
  const API_URL = '/api/products';
  let isSubmitting = false;
  let editingProductId = null;
  const productIdInput = document.getElementById('productId');
  const submitBtn = document.getElementById('submitBtn');
  const cancelEditBtn = document.getElementById('cancelEditBtn');
  const formTitle = document.getElementById('formTitle');

  function getAuthHeaders() {
    const token = sessionStorage.getItem('auth');
    return token ? { 'Authorization': `Bearer ${token}` } : {};
  }

  function showToast(msg, type) {
    alert(`${type.toUpperCase()}: ${msg}`);
  }

  function resetForm() {
    document.getElementById('productForm').reset();
    productIdInput.value = '';
    editingProductId = null;
    formTitle.textContent = 'Añadir Nuevo Producto';
    cancelEditBtn.style.display = 'none';
    document.getElementById('imgPreview').style.display = 'none';
  }

  document.getElementById('fileInput').addEventListener('change', async function () {
    const file = this.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('imagen', file);

    try {
      const response = await fetch(`${API_URL.replace('/products', '')}/upload`, {
        method: 'POST',
        headers: getAuthHeaders(),
        body: formData
      });

      if (!response.ok) throw new Error('Error al subir la imagen');

      const data = await response.json();
      document.getElementById('imagen').value = data.imageUrl;
      const imgPreview = document.getElementById('imgPreview');
      imgPreview.src = data.imageUrl;
      imgPreview.style.display = 'block';

    } catch (err) {
      console.error('Error al subir imagen:', err);
      showToast('No se pudo subir la imagen', 'error');
    }
  });

  document.getElementById('productForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    if (isSubmitting) return;
    isSubmitting = true;

    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

    const productData = {
      nombre: document.getElementById('nombre').value.trim(),
      categoria: document.getElementById('categoria').value,
      precio: parseFloat(document.getElementById('precio').value),
      precio_anterior: document.getElementById('precio_anterior').value ? parseFloat(document.getElementById('precio_anterior').value) : null,
      imagen: document.getElementById('imagen').value.trim(),
      etiqueta: document.getElementById('etiqueta').value.trim() || '',
      valoracion: document.getElementById('valoracion').value ? parseFloat(document.getElementById('valoracion').value) : 4.5,
      reseñas: document.getElementById('reseñas').value ? parseInt(document.getElementById('reseñas').value) : 10,
      unidad: document.getElementById('unidad').value.trim() || ''
    };

    const productId = productIdInput.value;
    const method = productId ? 'PUT' : 'POST';
    const url = productId ? `${API_URL}/${productId}` : API_URL;

    try {
      const response = await fetch(url, {
        method: method,
        headers: {
          ...getAuthHeaders(),
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(productData)
      });

      if (!response.ok) throw new Error(`Error ${response.status}`);

      resetForm();
      showToast('Producto guardado correctamente', 'success');

    } catch (error) {
      console.error('Error:', error);
      showToast(`Error: ${error.message}`, 'error');
    } finally {
      isSubmitting = false;
      submitBtn.disabled = false;
      submitBtn.innerHTML = 'Guardar';
    }
  });
</script>
